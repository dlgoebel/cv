---
title: "Equity market timing with unemployment"
author: David Goebel
output: github_document
---

# Systematic investment strategies

Using Unemployment trend as a guide to being invested in equity markets

## Get some data
```{r get_data}

rm(list=ls())

#load some required libraries
library(tidyverse);library(tidyquant);library(Rblpapi);library(PerformanceAnalytics);library(timetk), library(alfred);

start_date <- "1948-01-31" # we have a reasonable period over which we can look at the strategy

# get some data from bloomberg

blpConnect() #connect to bloomberg

tickers <- c("SPX Index")

rawdata <- tickers %>% tq_get(fields = c("PX_LAST", "TOT_RETURN_INDEX_GROSS_DVDS"), # get price and TR data
                              get="rblpapi",
                              from = start_date
                              )

data_wide <- rawdata %>% select(date, PX_LAST, TOT_RETURN_INDEX_NET_DVDS)

eq_total_returns=rawdata %>% select(date, TOT_RETURN_INDEX_NET_DVDS)
```

## Transform the data and add logic for trading

```{r manipulate_data}
lag_periods <- 2

data_wide <- data_wide %>% 
  tq_mutate(select = PX_LAST, # build a 200 day moving average of the price
            mutate_fun = rollapplyr,
            width = 200,
            fun = mean,
            na.rm = T,
            col_rename = "MA_200") %>% 
  mutate(MA_long = lag(ifelse(PX_LAST>MA_200,1,0), lag_periods)) %>% # be long when above
  mutate(MA_short = lag(ifelse(PX_LAST>MA_200,0,1), lag_periods)) %>% # be short when below
  tq_mutate(TOT_RETURN_INDEX_GROSS_DVDS,
            mutate_fun = periodReturn,
            period = "daily",
            col_rename = "SPX") %>% # calculate returns
              mutate(Strategy200DMA = MA_long*SPX+MA_short*0, # calcuate the returns of the momentum strategy 
                     MA_short_rets = MA_short*SPX+MA_long*0)
            
get <- get_alfred_series("UNRATE") #get the unemployment data from the alfred database

data <- get %>% group_by(realtime_period) %>% slice(n())

data <- data %>% ungroup() %>% tq_mutate(select = UNRATE, # calculate a moving average on the unemployment data
                                         mutate_fun = rollapplyr,
                                         wifth =12,
                                         FUN = mean,
                                         na.rm = T,
                                         col_rename = "SMA12")

data <- data %>% select(realtime_period, UNRATE, SMA12)

colnames(data)[1] <- "date"

data_wide <- data_wide %>% left_join(data, by= "date") %>% # join the unemployment data with the other data frame
  na.locf() %>% # carry forward last numbers for missing data
  mutate_at(c("UNRATE", "SMA12", "MA_200","SPX"), as.numeric)



  

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
